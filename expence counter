#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_EXPENSES 1000
#define MAX_TEXT 100
#define FILE_NAME "expenses.csv"

typedef struct {
    char description[MAX_TEXT];
    char category[MAX_TEXT];
    char date[11];        // YYYY-MM-DD
    double amount;
} Expense;

/* ---------- Utility Functions ---------- */

void clearInputBuffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

void readLine(char *buffer, int size) {
    if (fgets(buffer, size, stdin)) {
        size_t len = strlen(buffer);
        if (len > 0 && buffer[len - 1] == '\n')
            buffer[len - 1] = '\0';
    }
}

void pressEnter() {
    printf("Press Enter to continue...");
    getchar();
}

/* ---------- File Handling ---------- */

void loadExpenses(Expense expenses[], int *count) {
    FILE *file = fopen(FILE_NAME, "r");
    char line[512];
    *count = 0;

    if (!file) return;

    while (fgets(line, sizeof(line), file) && *count < MAX_EXPENSES) {
        Expense e;
        char *token;

        token = strtok(line, ",");
        if (!token) continue;
        strncpy(e.description, token, MAX_TEXT);

        token = strtok(NULL, ",");
        if (!token) continue;
        strncpy(e.category, token, MAX_TEXT);

        token = strtok(NULL, ",");
        if (!token) continue;
        strncpy(e.date, token, 11);

        token = strtok(NULL, ",");
        if (!token) continue;
        e.amount = atof(token);

        expenses[*count] = e;
        (*count)++;
    }

    fclose(file);
}

void saveExpenses(Expense expenses[], int count) {
    FILE *file = fopen(FILE_NAME, "w");
    if (!file) {
        printf("Error saving file!\n");
        return;
    }

    for (int i = 0; i < count; i++) {
        fprintf(file, "%s,%s,%s,%.2f\n",
                expenses[i].description,
                expenses[i].category,
                expenses[i].date,
                expenses[i].amount);
    }

    fclose(file);
}

/* ---------- Core Features ---------- */

void addExpense(Expense expenses[], int *count) {
    char temp[50];

    if (*count >= MAX_EXPENSES) {
        printf("Expense list is full.\n");
        pressEnter();
        return;
    }

    printf("Enter description: ");
    readLine(expenses[*count].description, MAX_TEXT);

    printf("Enter category: ");
    readLine(expenses[*count].category, MAX_TEXT);

    printf("Enter date (YYYY-MM-DD): ");
    readLine(expenses[*count].date, 11);

    printf("Enter amount: ");
    readLine(temp, sizeof(temp));
    expenses[*count].amount = atof(temp);

    (*count)++;
    printf("Expense added successfully.\n");
    pressEnter();
}

void listExpenses(Expense expenses[], int count) {
    if (count == 0) {
        printf("No expenses found.\n");
        pressEnter();
        return;
    }

    printf("\n===== EXPENSE LIST =====\n");
    for (int i = 0; i < count; i++) {
        printf("%d) %s | %s | %s | Rs. %.2f\n",
               i + 1,
               expenses[i].description,
               expenses[i].category,
               expenses[i].date,
               expenses[i].amount);
    }
    printf("========================\n");
    pressEnter();
}

void showTotal(Expense expenses[], int count) {
    double total = 0;
    for (int i = 0; i < count; i++)
        total += expenses[i].amount;

    printf("Total Spent: Rs. %.2f\n", total);
    pressEnter();
}

void totalByCategory(Expense expenses[], int count) {
    char category[MAX_TEXT];
    double total = 0;

    printf("Enter category: ");
    readLine(category, MAX_TEXT);

    for (int i = 0; i < count; i++) {
        if (strcmp(expenses[i].category, category) == 0)
            total += expenses[i].amount;
    }

    printf("Total in %s: Rs. %.2f\n", category, total);
    pressEnter();
}

void deleteExpense(Expense expenses[], int *count) {
    int choice;

    if (*count == 0) {
        printf("No expenses to delete.\n");
        pressEnter();
        return;
    }

    for (int i = 0; i < *count; i++) {
        printf("%d) %s | %s | %s | Rs. %.2f\n",
               i + 1,
               expenses[i].description,
               expenses[i].category,
               expenses[i].date,
               expenses[i].amount);
    }

    printf("Enter expense number to delete (0 cancel): ");
    scanf("%d", &choice);
    clearInputBuffer();

    if (choice <= 0 || choice > *count) return;

    for (int i = choice - 1; i < *count - 1; i++)
        expenses[i] = expenses[i + 1];

    (*count)--;
    printf("Expense deleted.\n");
    pressEnter();
}

/* ---------- Menu ---------- */

void printMenu() {
    printf("\n===== EXPENSE TRACKER =====\n");
    printf("1. Add Expense\n");
    printf("2. List Expenses\n");
    printf("3. Show Total Spent\n");
    printf("4. Total by Category\n");
    printf("5. Delete Expense\n");
    printf("6. Save & Exit\n");
    printf("Enter your choice: ");
}

/* ---------- Main ---------- */

int main() {
    Expense expenses[MAX_EXPENSES];
    int count = 0;
    int choice;

    loadExpenses(expenses, &count);

    while (1) {
        printMenu();

        if (scanf("%d", &choice) != 1) {
            clearInputBuffer();
            printf("Invalid input.\n");
            continue;
        }
        clearInputBuffer();

        switch (choice) {
            case 1: addExpense(expenses, &count); break;
            case 2: listExpenses(expenses, count); break;
            case 3: showTotal(expenses, count); break;
            case 4: totalByCategory(expenses, count); break;
            case 5: deleteExpense(expenses, &count); break;
            case 6:
                saveExpenses(expenses, count);
                printf("Data saved. Exiting...\n");
                return 0;
            default:
                printf("Invalid choice.\n");
        }
    }
}
