#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define MAX_EXPENSES 1000
#define MAX_TEXT 100
#define FILE_NAME "expenses.csv"

typedef struct {
    char description[MAX_TEXT];
    char category[MAX_TEXT];
    char date[11];      // YYYY-MM-DD
    double amount;
} Expense;

/* ---------- Utils ---------- */
void clearInputBuffer() {
    int c;
    while ((c = getchar()) != '\n' && c != EOF);
}

void readLine(char *buf, int size) {
    if (fgets(buf, size, stdin)) {
        size_t len = strlen(buf);
        if (len && buf[len - 1] == '\n')
            buf[len - 1] = '\0';
    }
}

void pressEnter() {
    printf("Press Enter to continue...");
    getchar();
}

/* ---------- File ---------- */
void loadExpenses(Expense e[], int *n) {
    FILE *f = fopen(FILE_NAME, "r");
    char line[512];
    *n = 0;
    if (!f) return;

    while (fgets(line, sizeof(line), f) && *n < MAX_EXPENSES) {
        char *t;
        t = strtok(line, ","); if (!t) continue; strncpy(e[*n].description, t, MAX_TEXT);
        t = strtok(NULL, ","); if (!t) continue; strncpy(e[*n].category, t, MAX_TEXT);
        t = strtok(NULL, ","); if (!t) continue; strncpy(e[*n].date, t, 11);
        t = strtok(NULL, ","); if (!t) continue; e[*n].amount = atof(t);
        (*n)++;
    }
    fclose(f);
}

void saveExpenses(Expense e[], int n) {
    FILE *f = fopen(FILE_NAME, "w");
    if (!f) return;
    for (int i = 0; i < n; i++)
        fprintf(f, "%s,%s,%s,%.2f\n",
                e[i].description, e[i].category, e[i].date, e[i].amount);
    fclose(f);
}

/* ---------- Core ---------- */
void addExpense(Expense e[], int *n) {
    if (*n >= MAX_EXPENSES) return;

    printf("Description: ");
    readLine(e[*n].description, MAX_TEXT);

    printf("Category: ");
    readLine(e[*n].category, MAX_TEXT);

    printf("Date (YYYY-MM-DD): ");
    readLine(e[*n].date, 11);

    printf("Amount: ");
    scanf("%lf", &e[*n].amount);
    clearInputBuffer();

    (*n)++;
    printf("Expense added successfully.\n");
    pressEnter();
}

void listExpenses(Expense e[], int n) {
    if (n == 0) {
        printf("No expenses found.\n");
        pressEnter();
        return;
    }
    for (int i = 0; i < n; i++)
        printf("%d) %s | %s | %s | Rs. %.2f\n",
               i + 1, e[i].description, e[i].category, e[i].date, e[i].amount);
    pressEnter();
}

void showTotal(Expense e[], int n) {
    double t = 0;
    for (int i = 0; i < n; i++) t += e[i].amount;
    printf("Total Spent: Rs. %.2f\n", t);
    pressEnter();
}

void totalByCategory(Expense e[], int n) {
    char cat[MAX_TEXT];
    double t = 0;
    printf("Category: ");
    readLine(cat, MAX_TEXT);
    for (int i = 0; i < n; i++)
        if (strcmp(e[i].category, cat) == 0) t += e[i].amount;
    printf("Total in %s: Rs. %.2f\n", cat, t);
    pressEnter();
}

void deleteExpense(Expense e[], int *n) {
    int c;
    if (*n == 0) return;

    for (int i = 0; i < *n; i++)
        printf("%d) %s | %s | %s | Rs. %.2f\n",
               i + 1, e[i].description, e[i].category, e[i].date, e[i].amount);

    printf("Delete number: ");
    scanf("%d", &c);
    clearInputBuffer();

    if (c < 1 || c > *n) return;

    for (int i = c - 1; i < *n - 1; i++)
        e[i] = e[i + 1];
    (*n)--;

    printf("Deleted.\n");
    pressEnter();
}

/* ---------- Menu ---------- */
void menu() {
    printf("\n1.Add\n2.List\n3.Total\n4.Category Total\n5.Delete\n6.Save & Exit\nChoice: ");
}

/* ---------- Main ---------- */
int main() {
    Expense e[MAX_EXPENSES];
    int n = 0, ch;

    loadExpenses(e, &n);

    while (1) {
        menu();
        if (scanf("%d", &ch) != 1) {
            clearInputBuffer();
            continue;
        }
        clearInputBuffer();

        switch (ch) {
            case 1: addExpense(e, &n); break;
            case 2: listExpenses(e, n); break;
            case 3: showTotal(e, n); break;
            case 4: totalByCategory(e, n); break;
            case 5: deleteExpense(e, &n); break;
            case 6:
                saveExpenses(e, n);
                printf("Saved. Bye!\n");
                return 0;
            default: printf("Invalid choice\n");
        }
    }
}
